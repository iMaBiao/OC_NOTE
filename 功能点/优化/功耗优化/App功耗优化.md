#### App功耗优化

[http://www.cocoachina.com/ios/20171205/21428.html]



https://developer.apple.com/library/content/documentation/Performance/Conceptual/EnergyGuide-iOS/





当app更新UI、执行网络操作或者在CPU中运行代码时，都会消耗电能。随着用户越来越依赖电池、app数量的激增，电池能效成了用户体验的重要组成部分。

##### 良好的用户体验需要如下要素：

电池寿命长。随着能效降低，电池寿命也会降低。但用户想让自己的移动设备全天候待命。

速度快。iOS系统处理复杂操作时仍能提供很好的性能。

响应快。同一时刻消耗太多资源会使UI卡顿，响应用户速度变慢。

温度低。app消耗的硬件资源的越多，系统工作越繁重，设备的温度就会逐渐上升。这时系统会通过一些措施降低设备温度。



##### 很多技术和操作影响着电量的使用：

**CPU**. CPU是电能消耗大户，高CPU使用量会迅速消耗掉用户的电池电量。app做的每件事几乎都需要用CPU，所以使用CPU要精打细算，真正有需要时通过分批、定时、有序地执行任务。

**设备唤醒**。iOS设备通过睡眠来节能。只要设备被唤醒，屏幕和其他的硬件资源就必须通电，会产生很高的间接功耗。如非必须，app要尽量保持闲置，不要推送消息或用其他方式唤醒设备，特别是app在后台的时候。

**网络操作**。大多数app都需要网络操作。网络通信时，蜂窝数据和Wi-Fi等元器件开始工作就会消耗电能。分批传输、减少传输、压缩数据、恰当地处理错误，你的app省电效果会很显著。

**图像、动画、视频**。app内容每次更新到屏幕上都需要消耗电能处理像素信息。动画和视频格外耗电。不经意的或者不必要的内容更新同样会消耗电能，所以UI不可见时，应该避免更新其内容。

**位置**。很多app为了记录用户的活动或者提供基于位置的服务会进行定位。定位精度越高，定位时间越长，消耗电量也就越多。所以app应该尽量降低定位精度、缩短定位时间。不需要位置信息之后立即停止定位。

**动作传感器**。长时间用不上加速度计、陀螺仪、磁力计等设备的动作数据时，应该停止更新数据，不然也会浪费电能。应按需获取，用完即停。

**蓝牙**。蓝牙活动频度太高会消耗电能，应该尽量分批、减少数据轮询等操作。



**固定能耗(Fixed Cost)和动态能耗(Dynamic Cost)**

iOS设备闲置时很擅长进入低功耗状态。即使是在两次键盘敲击的间隙这种毫秒级范围内，系统闲置时都能关掉很多硬件资源。

闲置时功率消耗很低，对功耗的影响很小。一旦开始执行任务，就会使用系统资源，这些系统资源都需要电能。但是，当设备什么都不干时，零散的任务会让设备进入一种中间状态，既不是闲置也不是活跃状态。在下个任务执行执行前，设备没有足够的时间从这些中间状态进入绝对闲置状态。这种情况下，电能就被白白浪费了。

我们app执行任务有动态能耗(dynamic cost)和固定能耗(fixed cost)。动态能耗也就是app实际工作消耗的能量。固定能耗是在任务执行前后把系统和各种资源调用起来和关闭所消耗的能量。出现大量零散的工作时，在零散的任务之间因为资源可能永远没法真正变为闲置，所以有动态能耗的同时固定能耗也很高。这种情况导致大量电能在相对较小的实际工作中流失了



**为减少固定能耗交换动态能耗**

你的app可以通过分批执行、降低执行频率来避免产生零散的任务。例如，不采用同一个线程串行执行一系列任务，而是把任务同时放到多个线程，如图2所示。每次使用CPU，内存、缓存、总线等都得通电。通过分批执行，组件可以只上一次，使用时间也更短。

因为给定时间内做了更多的工作，需要更多能量，这种策略会导致更大的前期动态功耗。作为交换，固定能耗减小了，随着时间推移，这会极大地节省电能。你的app提高了功率，但它更高效，用了更少的时间。这使得CPU回到闲置状态，其他元件也更快地断电。

开发app时，整个项目中应该全面地思考这种行为，尽量降低固定能耗。



#### **简化、有序地工作**

**减少后台工作**

实现UIApplicationDelegate中的方法，应用进入后台前做好暂停任务，保存数据等工作。如果确实需要完成用户执行的一些任务，应该调用UIApplicationDelegate中的beginBackgroundTaskWithExpirationHandler: 方法，这样后台任务可以继续执行几分钟。任务执行完毕后一定要调用endBackgroundTask:方法，不要等着系统强行挂起进程。

iOS8之后，系统引入了CPU监控机制，以观察后台app的CPU使用量是否超过了限制，如果超出限制，进程可能会被关闭。大多数情况下正常的后台任务不会遇到这种情况，如果遇到了可以查看崩溃日志信息，异常类型为EXC_RESOURCE，子类型为CPU_FATAL。



**用QoS分级有序工作**

多个app和众多操作需要共享CPU、缓存、网络等资源，为了保持高效，系统需要根据不同任务的优先级智能地管理这些工作。比如更新UI这种重要的事需要多分配资源，而一些后台任务可以延迟一些执行。服务质量(quality of service, 以下简称QoS, iOS8引入)级别可以通过NSOperation, NSOperationQueue, NSThread objects, dispatch queues, 和pthreads (POSIX threads)指定工作的优先级。有4种QoS级别（和2种特殊的级别），如表2所示，划线的两个特殊的级别一般不应该使用，仅作了解即可。最好情况是，用户不交互的时候，90%以上的时间让app运行在Utility或更低级别。



**少使用定时器**

app经常滥用定时器。想一下你app中的定时器，是否真的有必要存在。抛开具体场景不说，如果定时器触发太频繁，能耗影响是比较大的。

用事件通知代替定时器。有些app用定时器监控文件内容、网络或者其他状态的变化，这会导致CPU无法进入闲置状态而增加功耗。建议使用事件通知来代替定时器，比如使用dispatch source监测文件变化。对于系统提供的服务，尽量使用事件通知，

GCD里的dispatch queues、dispatch semaphores等同步工具比定时器效率高很多，尽量不要用定时器做同步工具。



所有需要指定一个最后期限的函数或方法都属于定时器，比如：

1. 高级定时器包括dispatch timer sources、CFRunLoopTimerCreate和其他CFRunLoopTimer函数、NSTimer、performSelector:withObject:afterDelay:方法。

2. 底层定时器包括sleep, usleep, nanosleep, pthread_cond_timedwait, select, poll, kevent, dispatch_after, dispatch_semaphore_wait。

如果一定要用定时器，尽量高效地使用，可以参照下列指导方针：

1. 设置一个合适的超时时间。

2. 不再需要时及时关闭重复性定时器。

3. 设置触发公差。



### **优化I/O访问**

app每次执行I/O任务，比如写文件，会导致系统退出闲置模式。而且写入缓存格外耗电。通过下列方法可以提高能效、改善app性能。

1. 减小写入数据。数据有变化再写文件，尽量把多个更改攒到一起一次性写入。如果只有几个字节的数据改变，不要把整个文件重新写入一次。如果你的app经常要修改大文件里很少的内容，可以考虑用数据库存储这些数据。

2. 避免访问存储频度太高。如果app要存储状态信息，要等到状态信息有变化时再写入。尽量分批修改，不要频繁地写入这些小变动。

3. 尽量顺序读写数据。在文件中跳转位置会消耗一些时间。

4. 尽量从文件读写大数据块，一次读取太多数据可能会引发一些问题。比如，读取一个32M文件的全部内容可能会在读取完成前触发内容分页。

5. 读写大量重要数据时，考虑用dispatch_io，其提供了基于GCD的异步操作文件I/O的API。用dispatch_io系统会优化磁盘访问。

6. 如果你的数据由随机访问的结构化内容组成，建议将其存储在数据库中，可以使用SQLite或Core Data访问。特别是需要操作的内容可能增长到超过几兆的时候。

7. 了解系统如何缓存文件、如何优化缓存的使用。如果你不打算多次引用某些数据，不要自己缓存数据。



#### **低电量模式**

iOS9之后，iPhone增加了低电量模式，用户如果希望延长iPhone电池的寿命，可以在设置 > 电池中开启该功能。开启该功能之后iOS会采取一些措施，比如：

1. 降低CPU和GPU性能

2. 暂停随意的和后台的活动，包括网络

3. 降低屏幕亮度

4. 缩短自动锁屏时间

5. 关闭邮件刷新

6. 关闭视角缩放

7. 关闭动态壁纸

你的app也应该做一些事情帮助系统节省电能，比如，可以减少动画、降低帧率、停止位置更新、关闭同步和备份功能等等。可以通过向NSNotificationCenter注册NSProcessInfoPowerStateDidChangeNotification通知监听低电量模式状态。




