

首页阅读[iOS 保持界面流畅的技巧]()



名词解释

- **在屏渲染（On-Screen Rendering）**

  指的是GPU的渲染操作是在当前用于显示的屏幕缓冲区进行

- **离屏渲染**

  指的是在GPU在当前屏幕缓冲区以外开辟一个缓冲区进行渲染操作



**屏幕显示图像的原理**

显示器 显示出来的图像是经过 CRT电子枪一行一行的扫描.(可以是横向的也可以是纵向 ,具体CRT电子枪又是什么,百度文库介绍的很详细.),扫描出来就呈现了一帧画面,随后电子枪又会回到初始位置循环扫描,为了让显示器的显示跟视频控制器同步,当电子枪新扫描一行的时候.准备扫描的时候,会发送一个 水平同步信号(HSync信号),而当一帧画面绘制完成后,电子枪回复到原位，准备画下一帧前，显示器会发出一个垂直同步信号（vertical synchronization简称 VSync），显示器一般是固定刷新频率的,这个刷新的频率其实就是VSync信号产生的频率. 然后CPU计算好frame等属性,就将计算好的内容提交给GPU去渲染,GPU渲染完成之后就会放入帧缓冲区,然后视频控制器会按照VSync信号逐行读取帧缓冲区的数据,经过可能的数模转换传递给显示器.就显示出来了.



离屏渲染的代价很高,想要进行离屏渲染,首选要创建一个新的缓冲区,屏幕渲染会有一个上下文环境的一个概念,离屏渲染的整个过程需要切换上下文环境,先从 当前屏幕切换到离屏,等结束后,又要将上下文环境切换回来.这也是为什么会消耗性能的原因了.
 。由于垂直同步的机制，如果在一个 VSync 时间内，CPU 或者 GPU 没有完成内容提交，则那一帧就会被丢弃，等待下一次机会再显示，而这时显示屏会保留之前的内容不变。这就是界面卡顿的原因。



当使用圆角，阴影，遮罩的时候，图层属性的混合体被指定为在未预合成之前(下一个VSync信号开始前)不能直接在屏幕中绘制，所以就需要屏幕外渲染。



##### 哪些操作会触发 离屏渲染?

- shouldRasterize（光栅化）

  （将图转化为一个个栅格组成的图象。 光栅化特点：每个元素对应帧缓冲区中的一像素。）

- masks（遮罩）

- shadows（阴影）

- edge antialiasing（抗锯齿）

- group opacity（不透明）

- 复杂形状设置圆角等

- 渐变

- Text（UILabel, CATextLayer, Core Text, etc）...





#### 官方对离屏渲染产生性能问题也进行了优化：

##### iOS9.0之前UIImageView跟UIButton设置圆角都会触发离屏渲染。

##### iOS9.0之后UIButton设置圆角会触发离屏渲染，而UIImageView设置圆角不会触发离屏渲染了，但是如果设置其他阴影效果之类的还是会触发离屏渲染

##### 第二种方式：使用贝塞尔曲线UIBezierPath和Core Graphics框架画出一个圆角

